name: Framework CI

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      task_id:
        description: "Optional task ID to force consistency-check target"
        required: false
        type: string

jobs:
  framework-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify PowerShell
        shell: pwsh
        run: |
          $PSVersionTable.PSVersion

      - name: Run docs-indexer
        shell: pwsh
        run: |
          pwsh -NoProfile -File tools/docs-indexer/index.ps1 -Mode check

      - name: Validate project profile
        shell: pwsh
        run: |
          pwsh -NoProfile -File tools/profile-validate/validate.ps1 -ProfilePath project.profile.yaml

      - name: Validate task states
        shell: pwsh
        run: |
          pwsh -NoProfile -File tools/state-validate/validate.ps1 -AllTasks

      - name: Resolve task ID
        id: resolve_task
        shell: pwsh
        env:
          EVENT_NAME: ${{ github.event_name }}
          HEAD_SHA: ${{ github.sha }}
          BASE_SHA_PR: ${{ github.event.pull_request.base.sha }}
          BASE_SHA_PUSH: ${{ github.event.before }}
          MANUAL_TASK_ID: ${{ inputs.task_id }}
        run: |
          $baseSha = ""
          if ($env:EVENT_NAME -eq "pull_request") {
            $baseSha = $env:BASE_SHA_PR
          } elseif ($env:EVENT_NAME -eq "push") {
            $baseSha = $env:BASE_SHA_PUSH
          }

          pwsh -NoProfile -File tools/ci/resolve-task-id.ps1 `
            -EventName $env:EVENT_NAME `
            -RepoRoot "." `
            -HeadSha $env:HEAD_SHA `
            -BaseSha $baseSha `
            -ManualTaskId $env:MANUAL_TASK_ID

      - name: Run consistency-check
        if: ${{ steps.resolve_task.outputs.resolved_task_source != 'skip' }}
        shell: pwsh
        run: |
          $taskId = "${{ steps.resolve_task.outputs.resolved_task_id }}"
          pwsh -NoProfile -File tools/improvement-harvest/scan.ps1 -TaskId $taskId
          pwsh -NoProfile -File tools/consistency-check/check.ps1 -TaskId $taskId

      - name: Skip consistency-check (no changed task)
        if: ${{ steps.resolve_task.outputs.resolved_task_source == 'skip' }}
        shell: pwsh
        run: |
          Write-Output "No task changes were detected under work/. consistency-check steps are skipped."
